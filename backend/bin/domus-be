#!/usr/bin/env node

var express = require('express'),
	app = express(),
	http = require('http'),
	mongojs = require('mongojs'),

	Domus = require('../lib/core').Domus;


var collections = ["widgets"]
app.configure(function () {
	app.set('listen_on', 8080);
	app.set('dbconnection', 'localhost/test');
});
app.configure('production', function () {
	app.set('listen_on', 80);
	app.set('dbconnection', process.env.DBCON);
});

var db = mongojs.connect(app.get('dbconnection'), collections);

app.get('/', function(req, res) {
	res.send(404, 'Invalid method');
});

app.get('/user/:user/widgets/', function (req, res) {
	// We don't have users yet, so sue me!
	db.widgets.find(function (err, widgets) {
		if (err || !widgets) return res.send(400, err);
		res.json(widgets);
	});
});

app.get('/widget/:widget_id', function (req, res) {
	var id = req.params.widget_id;
	if (!/^[a-f0-9]+$/.test(id)) {
		return res.send(400, 'Bad widget id');
	}

	db.widgets.findOne({_id: mongojs.ObjectId(id)}, function (err, widget) {
		if (err || !widget) return res.send(400, 'No such widget... dummy');

		Domus.getWidgetItems(widget, function (items) {
			res.json({ 'items' : items });
		});
	});
});

app.listen(app.get('listen_on'));
// vim: set syn=javascript :
