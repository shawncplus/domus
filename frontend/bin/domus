#!/usr/bin/env node

var Twig = require("twig"),
    express = require('express'),
    app = express(),
    crypto = require('crypto'),
    rest = require('restler');

var Domus = {
	config : {
		api_server: {
			host: 'http://localhost:8080',
		}
	}
};

app.configure(function () {
	app.set('listen_on', 9999);
});
app.configure('production', function () {
	app.set('listen_on', 80);
	Domus.config.api_server.host = 'http://shawncplus.domus-be.jit.su';
});

app.set('views', __dirname + '/../views');
app.use('/static', express.static(__dirname + '/../web'));
app.param(function(name, fn){
	if (fn instanceof RegExp) {
		return function(req, res, next, val){
			var captures;
			if (captures = fn.exec(String(val))) {
				req.params[name] = captures;
				next();
			} else {
				next('route');
			}
		}
	}
});

app.get('/', function(req, res) {
	res.render('home.html.twig', {
		widgets: [
			{
				id: crypto.createHash('md5').update('testshawn').digest('hex'),
				title: 'Shawn Biddle\'s Devblog',
				left: 0,
				top: 0
			}
		]
	});
});

app.param('widget_id', /^[a-f0-9]+$/);

app.get('/widget/:widget_id', function (req, res) {
	rest.get(Domus.config.api_server.host + '/widget/' + req.params.widget_id).on('complete', function (data) {
		res.json(data);
	});
});

app.listen(app.get('listen_on'));
// vim: set syn=javascript :
